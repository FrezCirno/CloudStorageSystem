<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Giraffe Object Storage System</title>
    <script>
        let username = '';
        let token = '';

        function updateToken(_username, _token) {
            username = _username;
            token = _token;
        }

        function signin(e, form) {
            e.preventDefault();
            fetch('/user/signin', {
                method: 'POST',
                body: new URLSearchParams({username: form.username.value, password: form.password.value})
            })
                .then(response => response.json())
                .then(response => response['data'])
                .then(x => {
                    console.log(x);
                    return x;
                })
                .then(data => updateToken(data['username'], data['accessToken']))
                .catch(error => console.error('Error:', error));
        }

        function signup(e, form) {
            e.preventDefault();
            fetch('/user/signup', {
                method: 'POST',
                body: new URLSearchParams({username: form.username.value, password: form.password.value})
            })
                .then(response => response.json())
                .then(response => response['data'])
                .then(x => {
                    console.log(x);
                    return x;
                })
                .then(data => updateToken(data['username'], data['accessToken']))
                .catch(error => console.error('Error:', error));
        }

        function upload(e, form) {
            e.preventDefault();
            let data = new FormData();
            data.append('file', form['file-selector'].files[0]);
            fetch('/file/upload', {
                method: 'POST',
                body: data,
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
                .then(response => response.json())
                .then(response => response['data'])
                .then(x => {
                    console.log(x);
                    return x;
                })
                .catch(error => console.error('Error:', error));
        }

        function fileMeta(e, form) {
            e.preventDefault();
            fetch('/file/meta?filehash=' + form.filehash.value, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
                .then(response => response.json())
                .then(response => response['data'])
                .then(x => {
                    console.log(x);
                    return x;
                })
                .catch(error => console.error('Error:', error));
        }

        function query(e, form) {
            e.preventDefault();
            fetch('/file/recent', {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
                .then(response => response.json())
                .then(response => response['data'])
                .then(x => {
                    console.log(x);
                    return x;
                })
                .catch(error => console.error('Error:', error));
        }

        function rename(e, form) {
            e.preventDefault();
            fetch('/file/update', {
                method: 'POST',
                body: new URLSearchParams({
                    filename: form.filename.value,
                    op: form.op.value,
                    newname: form.newname.value
                }),
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
                .then(response => response.json())
                .then(response => response['data'])
                .then(x => {
                    console.log(x);
                    return x;
                })
                .catch(error => console.error('Error:', error));
        }

        function download(e, form) {
            e.preventDefault();
            fetch('/file/download?filename=' + form.filename.value, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
                .then(res => res.blob())
                .then(blob => {
                    let file = window.URL.createObjectURL(blob);
                    window.location.assign(file);
                })
                .catch(error => console.error('Error:', error));
        }

    </script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.2/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        .header {
            border-bottom: 1.6px solid whitesmoke;
        }
    </style>
</head>
<body>

<nav class="level header">
    <div class="level-left">
        <p class="level-item has-text-centered">
            <a href="/"><span>Logo</span></a>
        </p>
        <p class="level-item has-text-centered">
            <a href="error.html" class="link is-info">Menu</a>
        </p>
        <p class="level-item has-text-centered">
            <a class="link is-info">Reservations</a>
        </p>
        <p class="level-item has-text-centered">
            <a class="link is-info">Contact</a>
        </p>
        <div class="field has-addons">
            <p class="control">
                <input class="input" type="text" placeholder="Find a post">
            </p>
            <p class="control">
                <button class="button">
                    Search
                </button>
            </p>
        </div>
    </div>
    <div class="level-right">
        <p class="level-item"><strong>All</strong></p>
        <p class="level-item"><a>Published</a></p>
        <p class="level-item"><a>Drafts</a></p>
        <p class="level-item"><a>Deleted</a></p>
        <p class="level-item"><a class="button is-success">New</a></p>
    </div>
</nav>

<div class="container">
    <div class="notification is-primary">
        This container is <strong>centered</strong> on desktop and larger viewports.
    </div>

    <div class="tile is-ancester">
        <div class="tile is-parent">
            <div class="tile box">
                <form action="#" onsubmit="signup(event, this)">
                    <div class="field">
                        <label class="label">用户名:</label>
                        <div class="control has-icons-left">
                            <input class="input" name="username" type="text">
                            <span class="icon is-left">
                        <i class="fas fa-user"></i>
                    </span>
                        </div>
                        <p class="help is-success">This username is available</p>
                    </div>
                    <div class="field">
                        <label class="label">密码:</label>
                        <div class="control has-icons-left">
                            <input class="input" name="password" type="password">
                            <span class="icon is-left">
                        <i class="fas fa-key"></i>
                    </span>
                        </div>
                    </div>
                    <button class="button is-primary" type="submit">注册</button>
                    <button class="button" type="reset">重置</button>
                </form>
            </div>
        </div>
        <div class="tile is-parent">
            <div class="tile box">
                <form action="#" onsubmit="
            event.preventDefault();
            fetch('/time')
            .then(resp => resp.text())
            .then(text => { document.getElementById('time').textContent = text; })
            .catch(err => console.log('Error: ' + err));
        ">
                    <h1 id="time" class="title is-1">获取时间...</h1>
                    <button class="button primary" type="submit">更新</button>
                </form>
            </div>
        </div>
        <div class="tile is-parent">
            <div class="tile box">
                <form action="#" onsubmit="signin(event, this)">
                    <div class="field">
                        <label class="label">用户名:</label>
                        <div class="control has-icons-left">
                            <input class="input" name="username" type="text">
                            <span class="icon is-left">
                        <i class="fas fa-user"></i>
                    </span>
                        </div>
                        <p class="help is-success">This username is available</p>
                    </div>
                    <div class="field">
                        <label class="label">密码:</label>
                        <div class="control has-icons-left">
                            <input class="input" name="password" type="password">
                            <span class="icon is-left">
                        <i class="fas fa-key"></i>
                    </span>
                        </div>
                    </div>
                    <button class="button is-primary" type="submit">登录</button>
                    <button class="button" type="reset">重置</button>
                </form>
            </div>
        </div>
    </div>
    <div class="tile is-ancester">
        <div class="tile is-parent">
            <div class="tile box">
                <form action="#" onsubmit="upload(event, this)">
                    <div class="field">
                        <label class="label">选择文件:</label>
                        <div class="control has-icons-left">
                            <input class="input" name="file-selector" type="file" multiple>
                            <span class="icon is-left">
                                <i class="fas fa-file"></i>
                            </span>
                        </div>
                    </div>

                    <button class="button is-primary" type="submit">上传</button>
                    <button class="button" type="reset">重置</button>
                </form>
            </div>
        </div>
        <div class="tile is-parent">
            <div class="tile box">
                <form action="#" onsubmit="fileMeta(event, this)">
                    <div class="field">
                        <label class="label">文件哈希:</label>
                        <div class="control has-icons-left">
                            <input class="input" type="text" name="filehash">
                            <span class="icon is-left">
                        <i class="fas fa-key"></i>
                    </span>
                        </div>
                    </div>
                    <button class="button is-primary" type="submit">查询</button>
                    <button class="button" type="reset">重置</button>
                </form>
            </div>
        </div>
        <div class="tile is-parent">
            <div class="tile box">
                <form action="#" onsubmit="query(event, this)">
                    <button class="button is-primary" type="submit">查询</button>
                </form>
            </div>
        </div>
    </div>
    <div class="tile is-ancester">
        <div class="tile is-parent">
            <div class="tile box">
                <form action="#" onsubmit="rename(event, this)">
                    <div class="field">
                        <label class="label">旧文件名:</label>
                        <div class="control has-icons-left">
                            <input class="input" name="filename" type="text">
                            <span class="icon is-left">
                                <i class="fas fa-key"></i>
                            </span>
                        </div>
                    </div>
                    <div class="field">
                        <label class="label">新文件名:</label>
                        <div class="control has-icons-left">
                            <input class="input" name="newname" type="text">
                            <span class="icon is-left">
                                <i class="fas fa-book"></i>
                            </span>
                        </div>
                    </div>
                    <div class="field">
                        <label class="label">操作编码:</label>
                        <div class="control has-icons-left">
                            <input class="input" disabled type="text" name="op" value="rename">
                            <span class="icon is-left">
                                <i class="fas fa-book"></i>
                            </span>
                        </div>
                    </div>

                    <button class="button is-primary" type="submit">修改</button>
                    <button class="button" type="reset">重置</button>
                </form>
            </div>
        </div>
        <div class="tile is-parent">
            <div class="tile box">
                <div>
                    <form action="#" onsubmit="download(event, this)">
                        <div class="field">
                            <label class="label">文件名:</label>
                            <div class="control has-icons-left">
                                <input class="input" name="filename" type="text">
                                <span class="icon is-left">
                                <i class="fas fa-key"></i>
                            </span>
                            </div>
                        </div>

                        <button class="button is-primary" type="submit">下载</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="tile is-parent">
            <div class="tile box">
                <div>
                    <form action="/file/download" method="GET">
                        <label class="label">文件hash:</label>
                        <input class="input" type="text" name="filehash">
                        <label class="label"></label>
                        <input class="input" hidden type="text" name="username">
                        <label class="label"></label>
                        <input class="input" hidden type="text" name="token">
                        <button type="submit">下载</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<footer class="footer">
    <div class="content has-text-centered">
        <p>
            Footer
        </p>
    </div>
</footer>

</body>
</html>